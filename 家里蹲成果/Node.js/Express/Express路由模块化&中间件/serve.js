// æœåŠ¡å™¨,è°ƒç”¨è·¯ç”±æ¨¡å—é¡µé¢
const express = require("express"); // å¯¼å…¥å¿«
const app = express(); // åˆ›å»ºæœåŠ¡å™¨
// å¯¼å…¥è·¯ç”±æ¨¡å—
// è™½ç„¶.jsä¼šè¢«è¡¥å…¨,ä½†æ˜¯,å†™äº†å¥½
const router = require("./router.js");
// æˆ‘çš„æ ¼å±€è¿˜æ˜¯å°äº†,åªè¦æ˜¯è·¯ç”±åˆ›å»ºå’Œè¿è¡ŒæœåŠ¡å™¨ä¹‹é—´çš„æ“ä½œ,éƒ½å¯ä»¥ç†è§£ä¸ºæ…å±æ£,æ‰€æœ‰ç»‘å†appä¸Šçš„éƒ½å¯ä»¥å«åšä¸­é—´ä»¶
(function å…¨å±€ä¸­é—´ä»¶() {
  // ä¸­é—´ä»¶,è¯·æ±‚ â†’ æ…å±æ£ â†’ å“åº”,è¿™ä¸ªæ…å±æ£å°±æ˜¯ä¸­é—´ä»¶,æœ‰ç‚¹åƒaxiosçš„è¯·æ±‚æ‹¦æˆª;æ³¨æ„:æ²¡æœ‰è¯·æ±‚æ…å±æ£å°±æ— å±å¯æ…,ä¹Ÿå¯ä»¥æŠŠä¸­é—´ä»¶ç†è§£æˆæ— è®ºget,postéƒ½ä¼šæ‰§è¡Œçš„è¯·æ±‚å‡½æ•°,å¹¶ä¸”ä¸æ‰€æœ‰äººå…±äº«æ•°æ®
  // ä¸­é—´ä»¶æ¯”è¯·æ±‚å‡½æ•°å¤šäº†next,è¡¨ç¤ºè¿™æ ¹å·²ç»æ²¾äº†å±äº†,æ¢ä¸‹ä¸€æ ¹
  // ä¸­é—´ä»¶ä½¿ç”¨app.use()æ³¨å†Œå…¨å±€è°ƒç”¨
  // åˆ›å»ºä¸€ä¸ªæœ€ç®€å•çš„ä¸­é—´ä»¶
  const mv = function (req, res, next) {
    console.log("æˆ‘æ˜¯ä¸€ä¸ªå…¨å±€ä¸­é—´ä»¶");
    // å®šä¹‰ä¸€ä¸ªæ—¶é—´,è¿™ä¸ªæ—¶é—´æ˜¯è¯·æ±‚ä¸€è¢«æ¥æ”¶å°±å¾—åˆ°ç°åœ¨è¿›è¡Œæ—¶
    const time = Date.now();
    // æ•°æ®å…±äº«ä»…é™req,res,æ‰€ä»¥,æŒ‚è½½
    req.time = time;
    // nextè¿›å…¥ä¸‹ä¸€ä¸ªæµç¨‹,å¯èƒ½æ˜¯ä¸€ä¸ªä¸­é—´ä»¶æˆ–è€…å“åº”
    next();
  };
  // æ³¨å†Œå…¨å±€ä¸­é—´ä»¶;æ³¨æ„:å¯ä»¥æå‰æŠŠæ£å­æ”¾é©¬æ¡¶é‡Œ
  // å¯ä»¥å®šä¹‰å¤šä¸ªå…¨å±€ä¸­é—´ä»¶,ä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ
  app.use(mv);
})();
(function å±€éƒ¨ä¸­é—´ä»¶() {
  // å®šä¹‰å±€éƒ¨ä¸­é—´ä»¶
  const mv1 = function (req, res, next) {
    console.log("æˆ‘æ˜¯url=bbbçš„å±€éƒ¨ä¸­é—´ä»¶");
    // å“åº”ä½“æŒ‚ä¸ªæ•°æ®è¿‡å»ç»™å®¢æˆ·ç«¯
    // res.hello = "æˆ‘æ˜¯url=bbbçš„å±€éƒ¨ä¸­é—´ä»¶";
    // å¿˜è®°åœæ­¢ğŸ¥²
    next();
  };
  // å®šä¹‰å±€éƒ¨ä¸­é—´ä»¶2
  const mv2 = function (req, res, next) {
    console.log("æˆ‘æ˜¯url=bbbçš„å±€éƒ¨ä¸­é—´ä»¶2å·");
    res.hello += " æˆ‘æ˜¯url=bbbçš„å±€éƒ¨ä¸­é—´ä»¶2å·";
    next();
  };
  // å†™ä¸ªurl=bbbæ—¶çš„è·¯ç”±
  // ä¸­é—´ä»¶å¯ä»¥å¤šä¸ª,å¯ä»¥ä½¿ç”¨[]åŒ…è£¹,æ›´æ¸…æ™°,ä¹Ÿå¯ä»¥ä¸ç”¨[]!!!!
  app.get("/bbb", [mv1, mv2], (req, res) => {
    // å¿˜è®°sendğŸ˜…å®¢æˆ·ç«¯ä¸€ç›´ç­‰å¾…
    res.send("url=bbbçš„è¯·æ±‚æ‰§è¡Œäº†" + res.hello);
  });
})();

(function äº”ç§ä¸­é—´ä»¶() {
  // 1.æ‰˜ç®¡é™æ€èµ„æº,è¿™é‡Œå°±ä¸èµ˜è¿°äº†

  // 2.è§£æJSONçš„è¯·æ±‚ä½“æ•°æ®
  // ä¸åŠ è¿™ä¸ª,res.body=undefined
  // å°±ä¸€å¥è¯?å…¨å±€æŒ‚è½½å°±å®Œäº‹äº†,postçš„è¯·æ±‚ä½“bodyå¯ä»¥æ‹¿åˆ°äº†(req.body)
  app.use(express.json());

  // 3.è§£æURL-encodedæ ¼å¼çš„è¯·æ±‚ä½“æ•°æ®
  // ä¸åŠ è¿™ä¸ª,res.body=ç©º{}
  app.use(express.urlencoded({ extended: false })); //å›ºå®šå†™æ³•

  // 0000.å…ˆæ¥ä¸ªè¯·æ±‚,ä¸ç„¶å¤ªéº»çƒ¦
  app.post("/ccc", (req, res) => {
    // throw new Error("æŠ›ä¸ªé”™è¯¯ç©ç©")
    // req.bodyå¯ä»¥æ‹¿åˆ°è¯·æ±‚å¯¹è±¡çš„è¯·æ±‚ä½“
    res.send("cccå“åº”æ•°æ®æˆåŠŸ");
    console.log(req.body); //æ‹¿åˆ°bodyäº†
  });
  // 4.é”™è¯¯çº§åˆ«
  // ç‰¹ç‚¹:å¤šäº†ä¸€ä¸ªerr
  // æ³¨æ„:ä¸­é—´ä»¶ä¸Šåˆ°ä¸‹,è®°å¾—è¿™ç©æ„å†™æœ€åæ‰èƒ½å…¨æ•æ‰
  // æŠ›å‡ºé”™è¯¯,è¿˜è®°å¾—ä¸: throw new Error("æŠ›ä¸ªé”™è¯¯ç©ç©")
  app.use(function (err, req, res, next) {
    console.log("é”™å•¦é”™å•¦" + err.message); // æœåŠ¡å™¨ä¸­æ‰“å°
    res.send("Error!" + err.message); // ç»™å®¢æˆ·ç«¯ä¹Ÿæ•´ä¸ª
    next();
  });
})();
//  æ³¨å†Œè·¯ç”±æ¨¡å—
// app.useç”¨æ¥æ³¨å†Œå…¨å±€ä¸­é—´ä»¶
// app.use(router) // è¿™ç§ç”¨æˆ·å¤ªè½»æ¾
app.use("/aaa", router); //è¿™ç§å¯ä»¥è®©ç”¨æˆ·å¤šè¾“å…¥ä¸€ä¸ªabc
app.listen(80, function () {
  console.log("http://127.0.0.1");
}); //å¯åŠ¨æœåŠ¡å™¨
